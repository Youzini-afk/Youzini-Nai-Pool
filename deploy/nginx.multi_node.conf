## Example Nginx config for multi-node NovelAI Pool (L4/L7 load balancing).
##
## Notes:
## - Nginx OSS doesn't provide active health checks by default; this uses passive checks (max_fails/fail_timeout).
## - Make sure every node uses the SAME SECRET_KEY and ENCRYPTION_KEY (and DB) if you want shared auth/key pool.
## - If you only do "multi-node, separate DB per node", you can still load balance for availability,
##   but users and keys won't be shared across nodes.

upstream novelai_pool_nodes {
    least_conn;
    # Replace with your backend nodes
    server 127.0.0.1:5002 max_fails=2 fail_timeout=10s;
    # server 10.0.0.2:5002 max_fails=2 fail_timeout=10s;
    # server 10.0.0.3:5002 max_fails=2 fail_timeout=10s;
    keepalive 64;
}

server {
    listen 80;
    server_name example.com;

    # Optional: quick health check from outside
    location = /healthz {
        proxy_pass http://novelai_pool_nodes;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://novelai_pool_nodes;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Failover behavior
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_read_timeout 120s;
    }
}

